name: Build node on push

on:
   push:
      branches: [ "main" ]
   pull_request:
      branches: [ "main" ]
   workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # setup node (v22)
      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '22'
      
      # install npm dependencies
      - name: Install dependencies
        run: npm install

      # build node solution
      - name: Build node solution
        run: node --run build

      # push to repository. Ignore push errors - i.e. if there are no changes to the compiled .js files 
      - name: Push to repository
        continue-on-error: true
        run: |
          git config user.name ${{ secrets.USERNAME }}
          git config user.email ${{ secrets.EMAIL }}
          now=$(date)
          git add /release/*.js
          git commit -m "Auto build of /release/*.js from /src/ [$now]"
          git push